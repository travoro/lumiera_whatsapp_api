name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools

    - name: Check for outdated packages
      id: check
      run: |
        pip install -r requirements.txt
        pip list --outdated > outdated.txt
        cat outdated.txt
        if [ -s outdated.txt ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
        fi

    - name: Create issue for outdated packages
      if: steps.check.outputs.has_updates == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const outdated = fs.readFileSync('outdated.txt', 'utf8');

          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ“¦ Outdated Dependencies Detected',
            body: `## Outdated Python Packages\n\nThe following packages have updates available:\n\n\`\`\`\n${outdated}\n\`\`\`\n\n### Action Required\n\n1. Review the updates\n2. Update \`requirements.txt\` if needed\n3. Run tests to ensure compatibility\n4. Close this issue once resolved\n\n*This issue was automatically created by the Dependency Updates workflow.*`,
            labels: ['dependencies', 'automated']
          });

          console.log(`Created issue #${issue.data.number}`);

  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: Auto-approve dependabot PRs
      if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
      run: gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Enable auto-merge for dependabot PRs
      if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
      run: gh pr merge --auto --squash "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
