name: CD - Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Only deploy if tests pass
    needs: []  # Add 'test' job from ci.yml if you want to run tests first

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    # Debug: Check if secrets are available
    - name: Debug secrets availability
      run: |
        echo "SSH_HOST is set: ${{ secrets.SSH_HOST != '' }}"
        echo "SSH_USERNAME is set: ${{ secrets.SSH_USERNAME != '' }}"
        echo "SSH_KEY is set: ${{ secrets.SSH_KEY != '' }}"
        echo "SSH_PORT is set: ${{ secrets.SSH_PORT != '' }}"

    # Option 1: Deploy via SSH
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.2.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT || 22 }}
        timeout: 300s
        command_timeout: 30m
        script: |
          cd ${{ secrets.DEPLOY_PATH || '/home/ceeai/whatsapp_api' }}
          git pull origin main
          source venv/bin/activate
          pip install -r requirements.txt

          # Run tests in production environment
          ./run_tests.sh || echo "Tests failed but continuing deployment"

          # Restart the service
          sudo systemctl restart lumiera-whatsapp.service

          # Check service status
          sleep 5
          sudo systemctl status lumiera-whatsapp.service

    # Option 2: Deploy to cloud platform (customize for your platform)
    - name: Deploy to Cloud Platform
      if: ${{ vars.DEPLOYMENT_METHOD == 'cloud' }}
      run: |
        echo "Add your cloud platform deployment commands here"
        # Examples:
        # - Google Cloud Run: gcloud run deploy
        # - AWS ECS/Fargate: aws ecs update-service
        # - Azure App Service: az webapp up
        # - Railway: railway up
        # - Heroku: git push heroku main

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Deployment successful!"
        else
          echo "❌ Deployment failed!"
        fi

    # Optional: Send Slack/Discord notification
    - name: Notify Slack
      if: ${{ always() }}
      uses: slackapi/slack-github-action@v2.1.1
      continue-on-error: true
      with:
        payload: |
          {
            "text": "Deployment ${{ job.status }} for ${{ github.repository }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deployment Status:* ${{ job.status }}\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
