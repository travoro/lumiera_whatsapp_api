# üî¥ CRITICAL BUG: Active Task Not Updated When User Selects Different Task

## The Problem

When a user selects a task from a list (e.g., "Task test 1"), the active task in the database **is NOT updated**. This causes the system to continue using the old active task, leading to confusion and incorrect behavior.

## What You Experienced

1. You were viewing details for "mural" task (task b5205811...)
2. Active task in database: `b5205811...` (mural)
3. You said "mettre a jour une autre tache" (update another task)
4. System showed list:
   - 1. Task test 1
   - 2. mural
5. You selected "1" (Task test 1)
6. **BUG**: Active task in database was NOT updated to "Task test 1"
7. Active task still: `b5205811...` (mural)
8. You sent comment: "le mur est fini"
9. System found active task `b5205811...` (mural) - **WRONG!**
10. System confirmed with "mural" instead of "Task test 1"

## Root Cause

When the agent shows a list of tasks for the user to choose from, and the user selects one, the system needs to:

1. ‚úÖ Parse the selection (e.g., "1" ‚Üí "Task test 1")
2. ‚ùå **MISSING**: Update active task in database
3. ‚ùå **MISSING**: Clear old active task context
4. ‚úÖ Start progress update session for selected task

**The active task update is missing entirely!**

## Code Locations Where This Happens

### Location 1: Direct Handler for Task Selection from Progress Update Intent
**File**: `src/handlers/message.py:handle_direct_action`
**Lines**: Around 380-470

**Current behavior**:
```python
# When user selects task from update_progress intent
if previous_intent == "update_progress":
    tasks = tasks_output
    index = int(option_number) - 1
    selected_task = tasks[index]
    task_id = selected_task.get("id")
    task_title = selected_task.get("title")

    # Set active task in database
    await project_context_service.set_active_task(
        user_id, task_id, task_title
    )  # ‚úÖ THIS EXISTS

    # Route to progress update
    return await handle_direct_action(
        action="update_progress",
        user_id=user_id,
        ...
    )
```

**Status**: ‚úÖ **This code path EXISTS and works correctly**

### Location 2: Agent Showing Custom Task List (Not from list_tasks_tool)
**File**: `src/services/progress_update/agent.py`
**Problem**: Agent can show a custom task list like:
```
1. Task test 1
2. mural
```

But this list is NOT coming from `list_tasks_tool` - it's generated by the agent itself!

**When user selects from this list**:
- The selection goes to the agent
- Agent needs to call a tool to update active task
- **BUG**: No such tool exists!
- Agent cannot update the active task

**What's needed**:
1. Agent should have a tool: `set_active_task_tool`
2. When user selects a task, agent should call this tool
3. Tool should update active task in database

### Location 3: Progress Update Agent After Showing Task List
**File**: `src/services/progress_update/tools.py`

**When agent shows task list (from `get_active_task_context_tool` or custom)**:
The agent needs a way to:
1. Capture user selection (1 or 2)
2. Map selection to task_id
3. Update active task in database

**Currently**: Agent has NO tool to do this!

**Solution**: Add new tool `set_active_task_tool` that agent can call

---

## The Fix

### Step 1: Add `set_active_task_tool` for Agent
**File**: `src/services/progress_update/tools.py`

```python
@tool
async def set_active_task_tool(
    user_id: str,
    task_id: str,
    task_title: str,
    project_id: str
) -> str:
    """Set the active task for a user.

    Call this tool when the user selects a task from a list.
    This ensures the system remembers which task they're working on.

    Args:
        user_id: User ID
        task_id: Task ID (UUID)
        task_title: Task title for logging
        project_id: Project ID the task belongs to

    Returns:
        Confirmation message
    """
    from src.services.project_context import project_context_service

    # Set active task in database
    success = await project_context_service.set_active_task(
        user_id, task_id, task_title
    )

    if success:
        log.info(
            f"‚úÖ Set active task: {task_title} (ID: {task_id[:8]}...)",
            user_id=user_id
        )
        return f"‚úÖ Active task set to: {task_title}"
    else:
        log.error(
            f"‚ùå Failed to set active task: {task_title}",
            user_id=user_id
        )
        return "‚ùå Failed to set active task. Please try again."
```

### Step 2: Add Tool to Agent
**File**: `src/services/progress_update/agent.py`

```python
from src.services.progress_update.tools import (
    add_progress_comment_tool,
    add_progress_image_tool,
    escalate_to_human_tool,
    exit_progress_update_session_tool,
    get_active_task_context_tool,
    get_progress_update_context_tool,
    mark_task_complete_tool,
    set_active_task_tool,  # ‚Üê ADD THIS
    start_progress_update_session_tool,
)
```

### Step 3: Update Agent Prompt
**File**: `src/services/progress_update/agent.py:PROGRESS_UPDATE_PROMPT`

Add to tools list:
```
OUTILS DISPONIBLES :
- get_active_task_context_tool : V√©rifier le contexte actif (projet/t√¢che) - UTILISE CECI EN PREMIER!
- set_active_task_tool : D√©finir la t√¢che active apr√®s que l'utilisateur s√©lectionne une t√¢che
- get_progress_update_context_tool : Voir l'√©tat de la session de mise √† jour
- start_progress_update_session_tool : D√©marrer une session pour une t√¢che
...
```

Add usage instructions:
```
QUAND L'UTILISATEUR S√âLECTIONNE UNE T√ÇCHE:
Si tu montres une liste de t√¢ches et l'utilisateur s√©lectionne un num√©ro (1, 2, etc.):
1. Appeler set_active_task_tool(user_id="{user_id}", task_id="<uuid>", task_title="<titre>", project_id="<project_id>")
2. Puis appeler start_progress_update_session_tool avec le m√™me task_id
```

### Step 4: Handle Custom Task Lists in Agent
**Scenario**: Agent shows custom list like:
```
1. Task test 1
2. mural
```

**Agent should**:
- Store task IDs in a way it can retrieve them
- When user says "1", map to task_id for "Task test 1"
- Call `set_active_task_tool` with correct task_id
- Then call `start_progress_update_session_tool`

**Challenge**: Agent cannot easily store state between turns

**Solution**: Agent should use `get_active_task_context_tool` which provides proper task list with IDs, not generate custom lists

---

## Testing Strategy

### Test Case 1: Select Task from List During Progress Update
```
1. User has active task "mural"
2. User says "update another task"
3. Agent shows task list
4. User selects "1" (Task test 1)
5. ‚úÖ Verify: Active task in DB updated to "Task test 1" (7aa8d933...)
6. ‚úÖ Verify: Progress update session created for "Task test 1"
7. User sends comment "finished the work"
8. ‚úÖ Verify: Comment added to "Task test 1", NOT "mural"
```

### Test Case 2: Select Task from Initial Task List
```
1. User says "show me my tasks"
2. System shows list with task IDs in metadata
3. User selects "tasks_1_fr"
4. ‚úÖ Verify: Active task updated to task #1
5. User says "update this task"
6. ‚úÖ Verify: System confirms correct task
```

### Test Case 3: Task Context Cleared on Exit
```
1. User has active task "Task test 1"
2. User says "update another task"
3. ‚úÖ Verify: Old active task cleared
4. User selects new task
5. ‚úÖ Verify: New active task set
```

---

## Summary

**The core issue**: When the progress update agent shows a task selection list and the user chooses a task, there's no mechanism to update the active task in the database.

**The fix**: Add `set_active_task_tool` that the agent can call to update the active task before starting the progress update session.

**Where to add**:
1. New tool in `src/services/progress_update/tools.py`
2. Add to agent's tool list in `src/services/progress_update/agent.py`
3. Update agent prompt to use the tool
4. Ensure agent gets task IDs from proper source (not custom lists)
